---
import Layout from '../../layouts/Layout.astro';

// Check if already logged in
const sessionCookie = Astro.cookies.get('sb-access-token');
if (sessionCookie) {
  return Astro.redirect('/admin/dashboard');
}
---

<Layout title="Admin Login - AI WrocDevs">
  <main class="login-page">
    <div class="login-container">
      <div class="login-card">
        <div class="logo-section">
          <h1><span class="gradient-text">AI WrocDevs</span></h1>
          <p>Admin Panel</p>
        </div>

        <form id="login-form" class="login-form">
          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              autocomplete="email"
              placeholder="admin@aiwrocdevs.com"
            />
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              autocomplete="current-password"
              placeholder="••••••••"
            />
          </div>

          <div id="error-message" class="error-message"></div>

          <button type="submit" class="btn btn-primary btn-full">
            <span class="btn-text">Sign In</span>
            <span class="btn-loading" style="display: none;">
              <svg class="spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Signing in...
            </span>
          </button>
        </form>

        <div class="login-footer">
          <a href="/" class="back-link">← Back to Home</a>
        </div>
      </div>
    </div>
  </main>
</Layout>

<style>
  .login-page {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background:
      linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%),
      var(--bg-primary);
    padding: 2rem;
  }

  .login-container {
    width: 100%;
    max-width: 450px;
  }

  .login-card {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 1.5rem;
    padding: 3rem;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
  }

  .logo-section {
    text-align: center;
    margin-bottom: 3rem;
  }

  .logo-section h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .logo-section p {
    color: var(--text-secondary);
    font-size: 1rem;
  }

  .login-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    color: var(--text-primary);
    font-weight: 500;
    font-size: 0.95rem;
  }

  .form-group input {
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 0.875rem 1rem;
    color: var(--text-primary);
    font-size: 1rem;
    transition: all 0.3s ease;
    font-family: inherit;
  }

  .form-group input:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .form-group input::placeholder {
    color: var(--text-secondary);
    opacity: 0.5;
  }

  .error-message {
    color: var(--error);
    font-size: 0.9rem;
    padding: 0.75rem;
    background-color: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 0.5rem;
    display: none;
  }

  .error-message.show {
    display: block;
  }

  .btn-full {
    width: 100%;
    margin-top: 0.5rem;
  }

  .btn-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .spinner {
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .login-footer {
    margin-top: 2rem;
    text-align: center;
  }

  .back-link {
    color: var(--text-secondary);
    font-size: 0.95rem;
    transition: color 0.3s ease;
  }

  .back-link:hover {
    color: var(--accent-primary);
  }

  @media (max-width: 768px) {
    .login-card {
      padding: 2rem;
    }
  }
</style>

<script>
  import { supabase } from '../../lib/supabase';

  const form = document.getElementById('login-form') as HTMLFormElement;
  const errorMessage = document.getElementById('error-message') as HTMLDivElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;

    const btnText = form.querySelector('.btn-text') as HTMLElement;
    const btnLoading = form.querySelector('.btn-loading') as HTMLElement;
    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;

    // Show loading state
    btnText.style.display = 'none';
    btnLoading.style.display = 'flex';
    submitBtn.disabled = true;
    errorMessage.classList.remove('show');

    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (error) {
        throw error;
      }

      if (data.session) {
        // Store session in cookies
        document.cookie = `sb-access-token=${data.session.access_token}; path=/; max-age=3600; SameSite=Lax`;
        document.cookie = `sb-refresh-token=${data.session.refresh_token}; path=/; max-age=604800; SameSite=Lax`;

        // Redirect to dashboard
        window.location.href = '/admin/dashboard';
      }
    } catch (error: any) {
      errorMessage.textContent = error.message || 'Invalid email or password';
      errorMessage.classList.add('show');

      // Reset button state
      btnText.style.display = 'block';
      btnLoading.style.display = 'none';
      submitBtn.disabled = false;
    }
  });
</script>
