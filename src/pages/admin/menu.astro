---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';
import type { MenuItem } from '../../lib/supabase';

// Check authentication
const sessionCookie = Astro.cookies.get('sb-access-token');
if (!sessionCookie) {
  return Astro.redirect('/admin/login');
}

// Fetch all menu items
let menuItems: MenuItem[] = [];
let error: string | null = null;

try {
  const { data, error: fetchError } = await supabase
    .from('menu_items')
    .select('*')
    .order('display_order', { ascending: true });

  if (fetchError) {
    error = fetchError.message;
  } else {
    menuItems = data as MenuItem[];
  }
} catch (e) {
  error = 'Failed to load menu items';
  console.error('Error:', e);
}
---

<Layout title="Manage Menu - Admin">
  <main class="dashboard-page">
    <div class="dashboard-header">
      <div class="container">
        <div class="header-content">
          <div>
            <h1><span class="gradient-text">Manage Menu</span></h1>
            <p>Edit navigation menu items</p>
          </div>
          <div class="header-actions">
            <a href="/admin/dashboard" class="btn btn-secondary">Back to Dashboard</a>
            <button id="add-item-btn" class="btn btn-primary">+ Add Item</button>
          </div>
        </div>
      </div>
    </div>

    <div class="container dashboard-container">
      <div id="success-message" class="success-message">
        Menu updated successfully!
      </div>

      <div id="error-message" class="error-message"></div>

      {error && (
        <div class="error-message show">
          {error}
        </div>
      )}

      <div class="menu-editor">
        <div class="info-card">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          <p>Drag items to reorder. Changes are saved automatically.</p>
        </div>

        <div id="menu-items-container" class="menu-items-container">
          {menuItems.map((item) => (
            <div class="menu-item-card" data-id={item.id}>
              <div class="drag-handle">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="3" y1="12" x2="21" y2="12"></line>
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
              </div>

              <div class="menu-item-content">
                <div class="form-row">
                  <div class="form-group">
                    <label>Label</label>
                    <input
                      type="text"
                      class="menu-label"
                      value={item.label}
                      placeholder="Menu Label"
                    />
                  </div>
                  <div class="form-group">
                    <label>URL</label>
                    <input
                      type="text"
                      class="menu-url"
                      value={item.url}
                      placeholder="/page-url"
                    />
                  </div>
                </div>

                <div class="menu-item-actions">
                  <label class="toggle-label">
                    <input type="checkbox" class="menu-visible" checked={item.is_visible} />
                    <span>Visible</span>
                  </label>
                  <button class="btn-icon save-item-btn" title="Save changes">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </button>
                  <button class="btn-icon btn-danger delete-item-btn" title="Delete item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>

        {menuItems.length === 0 && !error && (
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
            <h3>No menu items</h3>
            <p>Add your first menu item to get started</p>
          </div>
        )}
      </div>
    </div>
  </main>
</Layout>

<style>
  .dashboard-page {
    min-height: 100vh;
    background-color: var(--bg-primary);
    padding-bottom: 4rem;
  }

  .dashboard-header {
    background-color: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    padding: 2rem 0;
    margin-bottom: 2rem;
  }

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .header-content h1 {
    font-size: 2rem;
    margin-bottom: 0.25rem;
  }

  .header-content p {
    color: var(--text-secondary);
    font-size: 1rem;
  }

  .header-actions {
    display: flex;
    gap: 1rem;
  }

  .dashboard-container {
    max-width: 900px;
  }

  .success-message,
  .error-message {
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
    display: none;
  }

  .success-message {
    background-color: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #34d399;
  }

  .success-message.show {
    display: block;
    animation: slideDown 0.3s ease-out;
  }

  .error-message {
    background-color: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #fca5a5;
  }

  .error-message.show {
    display: block;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .menu-editor {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 1rem;
    padding: 2rem;
  }

  .info-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background-color: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 0.5rem;
    margin-bottom: 2rem;
  }

  .info-card svg {
    color: var(--accent-primary);
    flex-shrink: 0;
  }

  .info-card p {
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin: 0;
  }

  .menu-items-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .menu-item-card {
    display: flex;
    gap: 1rem;
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
    cursor: move;
  }

  .menu-item-card:hover {
    border-color: var(--accent-primary);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
  }

  .menu-item-card.dragging {
    opacity: 0.5;
  }

  .drag-handle {
    display: flex;
    align-items: center;
    color: var(--text-secondary);
    cursor: grab;
  }

  .drag-handle:active {
    cursor: grabbing;
  }

  .menu-item-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    color: var(--text-primary);
    font-weight: 500;
    font-size: 0.875rem;
  }

  .form-group input {
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
    padding: 0.625rem;
    color: var(--text-primary);
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }

  .form-group input:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .menu-item-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .toggle-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    color: var(--text-secondary);
    font-size: 0.875rem;
  }

  .toggle-label input[type="checkbox"] {
    width: 1rem;
    height: 1rem;
    cursor: pointer;
  }

  .btn-icon {
    padding: 0.5rem;
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn-icon:hover {
    border-color: var(--accent-primary);
    background-color: rgba(59, 130, 246, 0.1);
  }

  .btn-icon.btn-danger {
    color: var(--error);
  }

  .btn-icon.btn-danger:hover {
    border-color: var(--error);
    background-color: rgba(239, 68, 68, 0.1);
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
  }

  .empty-state svg {
    color: var(--text-secondary);
    opacity: 0.5;
    margin-bottom: 1.5rem;
  }

  .empty-state h3 {
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    color: var(--text-secondary);
  }

  @media (max-width: 768px) {
    .header-content {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .menu-item-card {
      flex-direction: column;
    }

    .drag-handle {
      display: none;
    }
  }
</style>

<script>
  import { supabase } from '../../lib/supabase';

  const container = document.getElementById('menu-items-container');
  const successMessage = document.getElementById('success-message');
  const errorMessage = document.getElementById('error-message');

  let draggedElement: HTMLElement | null = null;

  // Add new menu item
  document.getElementById('add-item-btn')?.addEventListener('click', async () => {
    try {
      // Get the highest display order
      const items = document.querySelectorAll('.menu-item-card');
      const maxOrder = items.length;

      const { data, error } = await supabase
        .from('menu_items')
        .insert({
          label: 'New Item',
          url: '/new-page',
          display_order: maxOrder,
          is_visible: true
        })
        .select()
        .single();

      if (error) throw error;

      // Reload page to show new item
      window.location.reload();
    } catch (error: any) {
      showError(error.message || 'Failed to add menu item');
    }
  });

  // Save individual item
  function attachSaveListeners() {
    document.querySelectorAll('.save-item-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const card = (e.currentTarget as HTMLElement).closest('.menu-item-card');
        if (!card) return;

        const id = card.getAttribute('data-id');
        const label = (card.querySelector('.menu-label') as HTMLInputElement).value;
        const url = (card.querySelector('.menu-url') as HTMLInputElement).value;
        const isVisible = (card.querySelector('.menu-visible') as HTMLInputElement).checked;

        try {
          const { error } = await supabase
            .from('menu_items')
            .update({
              label,
              url,
              is_visible: isVisible
            })
            .eq('id', id);

          if (error) throw error;

          showSuccess();
        } catch (error: any) {
          showError(error.message || 'Failed to save menu item');
        }
      });
    });
  }

  // Delete item
  function attachDeleteListeners() {
    document.querySelectorAll('.delete-item-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const card = (e.currentTarget as HTMLElement).closest('.menu-item-card');
        if (!card) return;

        const id = card.getAttribute('data-id');
        const label = (card.querySelector('.menu-label') as HTMLInputElement).value;

        if (!confirm(`Delete "${label}" from menu?`)) return;

        try {
          const { error } = await supabase
            .from('menu_items')
            .delete()
            .eq('id', id);

          if (error) throw error;

          card.remove();
          await updateDisplayOrder();
          showSuccess();
        } catch (error: any) {
          showError(error.message || 'Failed to delete menu item');
        }
      });
    });
  }

  // Drag and drop functionality
  function setupDragAndDrop() {
    const items = document.querySelectorAll('.menu-item-card');

    items.forEach(item => {
      item.setAttribute('draggable', 'true');

      item.addEventListener('dragstart', (e) => {
        draggedElement = item as HTMLElement;
        item.classList.add('dragging');
      });

      item.addEventListener('dragend', () => {
        item.classList.remove('dragging');
        draggedElement = null;
      });

      item.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container!, e.clientY);
        if (afterElement == null) {
          container?.appendChild(draggedElement!);
        } else {
          container?.insertBefore(draggedElement!, afterElement);
        }
      });
    });

    container?.addEventListener('dragend', async () => {
      await updateDisplayOrder();
    });
  }

  function getDragAfterElement(container: HTMLElement, y: number) {
    const draggableElements = [...container.querySelectorAll('.menu-item-card:not(.dragging)')];

    return draggableElements.reduce((closest: any, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;

      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  async function updateDisplayOrder() {
    const items = document.querySelectorAll('.menu-item-card');
    const updates: any[] = [];

    items.forEach((item, index) => {
      const id = item.getAttribute('data-id');
      updates.push({
        id,
        display_order: index
      });
    });

    try {
      for (const update of updates) {
        await supabase
          .from('menu_items')
          .update({ display_order: update.display_order })
          .eq('id', update.id);
      }
      showSuccess();
    } catch (error: any) {
      showError(error.message || 'Failed to update order');
    }
  }

  function showSuccess() {
    successMessage?.classList.add('show');
    setTimeout(() => {
      successMessage?.classList.remove('show');
    }, 3000);
  }

  function showError(message: string) {
    if (errorMessage) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
      setTimeout(() => {
        errorMessage.classList.remove('show');
      }, 5000);
    }
  }

  // Initialize
  attachSaveListeners();
  attachDeleteListeners();
  setupDragAndDrop();
</script>
